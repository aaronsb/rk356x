name: Build RK356X Image

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      board:
        description: 'Board to build for'
        required: true
        default: 'rock-3a'
        type: choice
        options:
          - rock-3a
          - quartz64-a
          - nanopi-r5s
          - station-m2
          - evb-rk3568
      build_type:
        description: 'Build type'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - uboot-only
          - kernel-only
          - rootfs-only

env:
  DEBIAN_RELEASE: bullseye
  KERNEL_VERSION: 5.10
  CROSS_COMPILE: aarch64-linux-gnu-

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf "/usr/local/share/boost"
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        sudo apt-get clean
        df -h

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc-aarch64-linux-gnu \
          g++-aarch64-linux-gnu \
          build-essential \
          libssl-dev \
          libncurses-dev \
          flex \
          bison \
          bc \
          kmod \
          cpio \
          rsync \
          debootstrap \
          qemu-user-static \
          binfmt-support \
          debian-archive-keyring \
          device-tree-compiler \
          python3 \
          python3-dev \
          python3-setuptools \
          swig \
          libpython3-dev \
          parted \
          dosfstools \
          e2fsprogs \
          wget \
          git \
          u-boot-tools \
          pigz \
          pixz

    - name: Set board configuration
      id: config
      run: |
        BOARD="${{ github.event.inputs.board || 'rock-3a' }}"
        echo "board=${BOARD}" >> $GITHUB_OUTPUT
        echo "Building for board: ${BOARD}"

        # Load board-specific configuration
        if [ -f "config/boards/${BOARD}.conf" ]; then
          source "config/boards/${BOARD}.conf"
          echo "config_loaded=true" >> $GITHUB_OUTPUT
        else
          echo "config_loaded=false" >> $GITHUB_OUTPUT
          echo "Warning: No config found for ${BOARD}, using defaults"
        fi

    - name: Cache toolchain
      uses: actions/cache@v4
      with:
        path: |
          ~/toolchain
          ~/.cache/armbian
        key: ${{ runner.os }}-toolchain-${{ hashFiles('config/toolchain.conf') }}
        restore-keys: |
          ${{ runner.os }}-toolchain-

    - name: Build U-Boot
      if: github.event.inputs.build_type == 'full' || github.event.inputs.build_type == 'uboot-only'
      continue-on-error: true
      run: |
        ./scripts/build-uboot.sh ${{ steps.config.outputs.board }}

    - name: Build Kernel
      if: github.event.inputs.build_type == 'full' || github.event.inputs.build_type == 'kernel-only'
      continue-on-error: true
      run: |
        ./scripts/build-kernel.sh ${{ steps.config.outputs.board }}

    - name: Build Rootfs
      if: github.event.inputs.build_type == 'full' || github.event.inputs.build_type == 'rootfs-only'
      continue-on-error: true
      run: |
        sudo ./scripts/build-rootfs.sh ${{ steps.config.outputs.board }}

    - name: Assemble Image
      if: github.event.inputs.build_type == 'full'
      continue-on-error: true
      run: |
        sudo ./scripts/assemble-image.sh ${{ steps.config.outputs.board }}

    - name: Calculate checksums
      if: github.event.inputs.build_type == 'full'
      continue-on-error: true
      run: |
        cd output
        sha256sum *.img > SHA256SUMS
        cat SHA256SUMS

    - name: Upload artifacts
      if: github.event.inputs.build_type == 'full'
      uses: actions/upload-artifact@v4
      with:
        name: rk356x-${{ steps.config.outputs.board }}-${{ github.sha }}
        path: |
          output/*.img
          output/*.img.xz
          output/SHA256SUMS
        retention-days: 30
        if-no-files-found: ignore

    - name: Upload U-Boot artifacts
      if: github.event.inputs.build_type == 'uboot-only' || github.event.inputs.build_type == 'full'
      uses: actions/upload-artifact@v4
      with:
        name: uboot-${{ steps.config.outputs.board }}-${{ github.sha }}
        path: |
          output/u-boot/*
        retention-days: 30
        if-no-files-found: ignore

    - name: Upload kernel artifacts
      if: github.event.inputs.build_type == 'kernel-only' || github.event.inputs.build_type == 'full'
      uses: actions/upload-artifact@v4
      with:
        name: kernel-${{ steps.config.outputs.board }}-${{ github.sha }}
        path: |
          output/kernel/*
        retention-days: 30
        if-no-files-found: ignore

    - name: Create release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          output/*.img.xz
          output/SHA256SUMS
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
