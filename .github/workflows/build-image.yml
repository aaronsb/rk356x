name: Build RK356X Image

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      board:
        description: 'Board to build for'
        required: true
        default: 'rk3568_custom'
        type: choice
        options:
          - rk3568_custom
      build_type:
        description: 'Build type'
        required: true
        default: 'config-only'
        type: choice
        options:
          - config-only
          - full-build

env:
  BUILDROOT_VERSION: 2024.08.1

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf "/usr/local/share/boost"
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        sudo apt-get clean
        df -h

    - name: Install Buildroot dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libssl-dev \
          libncurses-dev \
          bc \
          rsync \
          file \
          wget \
          cpio \
          unzip \
          python3 \
          python3-pyelftools \
          git

    - name: Set build configuration
      id: config
      run: |
        BOARD="${{ github.event.inputs.board || 'rk3568_custom' }}"

        # Auto-trigger full build on tags
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          BUILD_TYPE="full-build"
          echo "ðŸ·ï¸  Tag detected - forcing full build"
        else
          BUILD_TYPE="${{ github.event.inputs.build_type || 'config-only' }}"
        fi

        echo "board=${BOARD}" >> $GITHUB_OUTPUT
        echo "build_type=${BUILD_TYPE}" >> $GITHUB_OUTPUT
        echo "Building for board: ${BOARD}"
        echo "Build type: ${BUILD_TYPE}"

    - name: Cache Buildroot downloads
      uses: actions/cache@v4
      with:
        path: buildroot/dl
        key: buildroot-dl-${{ hashFiles('external/custom/configs/*') }}
        restore-keys: |
          buildroot-dl-

    - name: Download and extract Buildroot
      run: |
        wget -q https://buildroot.org/downloads/buildroot-${{ env.BUILDROOT_VERSION }}.tar.gz
        tar xzf buildroot-${{ env.BUILDROOT_VERSION }}.tar.gz
        # Save cached dl directory if it exists
        if [ -d buildroot/dl ]; then
          mv buildroot/dl dl_cache
        fi
        rm -rf buildroot
        mv buildroot-${{ env.BUILDROOT_VERSION }} buildroot
        # Restore cached dl directory
        if [ -d dl_cache ]; then
          mv dl_cache buildroot/dl
        fi
        echo "âœ… Buildroot extracted"
        test -f buildroot/Makefile && echo "âœ“ Makefile exists" || echo "âœ— Makefile MISSING!"

    - name: Load configuration
      env:
        BR2_EXTERNAL: ${{ github.workspace }}/external/custom
      run: |
        cd buildroot
        make ${{ steps.config.outputs.board }}_defconfig
        echo "âœ… Configuration loaded"

    - name: Validate configuration
      env:
        BR2_EXTERNAL: ${{ github.workspace }}/external/custom
      run: |
        cd buildroot
        make show-info
        echo "âœ… Configuration valid"

    - name: Build (if full-build)
      if: steps.config.outputs.build_type == 'full-build'
      env:
        BR2_EXTERNAL: ${{ github.workspace }}/external/custom
      run: |
        cd buildroot
        make -j$(nproc)
        ls -lh output/images/
      timeout-minutes: 120

    - name: Upload build artifacts
      if: steps.config.outputs.build_type == 'full-build'
      uses: actions/upload-artifact@v4
      with:
        name: buildroot-${{ steps.config.outputs.board }}-${{ github.sha }}
        path: |
          buildroot/output/images/*.tar.gz
          buildroot/output/images/Image
          buildroot/output/images/*.dtb
        retention-days: 30
        if-no-files-found: ignore

    - name: Prepare release artifacts
      if: startsWith(github.ref, 'refs/tags/') && steps.config.outputs.build_type == 'full-build'
      run: |
        cd buildroot/output/images
        VERSION="${{ github.ref_name }}"

        # Create release archive with all build artifacts
        tar czf "rk356x-${VERSION}-${{ steps.config.outputs.board }}.tar.gz" \
          rootfs.tar.gz \
          Image \
          *.dtb || true

        ls -lh
        echo "âœ… Release artifacts prepared"

    - name: Create release
      if: startsWith(github.ref, 'refs/tags/') && steps.config.outputs.build_type == 'full-build'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          buildroot/output/images/rk356x-*.tar.gz
          buildroot/output/images/rootfs.tar.gz
          buildroot/output/images/Image
          buildroot/output/images/*.dtb
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## RK356X Buildroot Image - ${{ github.ref_name }}

          **Board:** ${{ steps.config.outputs.board }}
          **Buildroot Version:** ${{ env.BUILDROOT_VERSION }}
          **Build Date:** ${{ github.event.head_commit.timestamp }}

          ### Included Artifacts:
          - `rk356x-*.tar.gz` - Complete image archive
          - `rootfs.tar.gz` - Root filesystem
          - `Image` - Linux kernel
          - `*.dtb` - Device tree blobs

          ### Quick Start:
          ```bash
          # Extract the complete archive
          tar xzf rk356x-${{ github.ref_name }}-${{ steps.config.outputs.board }}.tar.gz

          # Flash to SD card (replace /dev/sdX with your device)
          sudo dd if=sdcard.img of=/dev/sdX bs=4M status=progress
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
