From: Claude Code <claude@anthropic.com>
Date: Sun, 24 Nov 2025 20:00:00 +0000
Subject: [PATCH] net: stmmac: dwmac4: use 4.19 LTS DMA reset method for RK3568

Use blocking mdelay() approach from 4.19 LTS instead of readl_poll_timeout()
to allow PHY clock stabilization on RK3568 boards with external PHY
providing 125MHz clock (like MAXIO MAE0621A).

Signed-off-by: Claude Code <claude@anthropic.com>
---
 drivers/net/ethernet/stmicro/stmmac/dwmac4_lib.c | 18 +++++++++++++-----
 1 file changed, 13 insertions(+), 5 deletions(-)

diff --git a/drivers/net/ethernet/stmicro/stmmac/dwmac4_lib.c b/drivers/net/ethernet/stmicro/stmmac/dwmac4_lib.c
index abc123..def456 100644
--- a/drivers/net/ethernet/stmicro/stmmac/dwmac4_lib.c
+++ b/drivers/net/ethernet/stmicro/stmmac/dwmac4_lib.c
@@ -14,14 +14,22 @@

 int dwmac4_dma_reset(void __iomem *ioaddr)
 {
 	u32 value = readl(ioaddr + DMA_BUS_MODE);
+	int limit;

 	/* DMA SW reset */
 	value |= DMA_BUS_MODE_SFT_RESET;
 	writel(value, ioaddr + DMA_BUS_MODE);
+
+	/* Use 4.19 LTS method with blocking delays to allow PHY clock stabilization
+	 * on RK3568 boards with external PHY providing 125MHz clock */
+	limit = 20;
+	while (limit--) {
+		if (!(readl(ioaddr + DMA_BUS_MODE) & DMA_BUS_MODE_SFT_RESET))
+			break;
+		mdelay(10);
+	}

-	return readl_poll_timeout(ioaddr + DMA_BUS_MODE, value,
-				 !(value & DMA_BUS_MODE_SFT_RESET),
-				 500, 1000000);
+	if (limit < 0)
+		return -EBUSY;
+
+	return 0;
 }

 void dwmac4_set_rx_tail_ptr(void __iomem *ioaddr, u32 tail_ptr, u32 chan)
--
2.34.1
