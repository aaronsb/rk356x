#!/bin/sh
# Generate a consistent MAC address from CPU serial number
# This ensures the same board always gets the same MAC across reflashes

# Try devicetree first (ARM64), then /proc/cpuinfo (older kernels)
if [ -f /sys/firmware/devicetree/base/serial-number ]; then
    SERIAL=$(cat /sys/firmware/devicetree/base/serial-number | tr -d '\0')
elif [ -f /proc/device-tree/serial-number ]; then
    SERIAL=$(cat /proc/device-tree/serial-number | tr -d '\0')
else
    SERIAL=$(grep -m1 Serial /proc/cpuinfo | awk '{print $3}')
fi

if [ -z "$SERIAL" ]; then
    echo "Warning: No CPU serial found, using random MAC"
    exit 0
fi

# Generate MAC from last 10 hex chars of serial, with local admin bit set
# Format: 02:xx:xx:xx:xx:xx (02 = locally administered, unicast)
# Extract last 10 chars, then format as colon-separated pairs
LAST10=$(echo "$SERIAL" | sed 's/.*\(.\{10\}\)$/\1/')
MAC="02:$(echo "$LAST10" | sed 's/\(..\)/\1:/g' | sed 's/:$//')"

# Find ethernet interface
for iface in end0 end1 eth0 eth1; do
    if [ -d "/sys/class/net/$iface" ]; then
        ip link set "$iface" down
        ip link set "$iface" address "$MAC"
        ip link set "$iface" up
        echo "Set $iface MAC to $MAC (from serial $SERIAL)"
        break
    fi
done
