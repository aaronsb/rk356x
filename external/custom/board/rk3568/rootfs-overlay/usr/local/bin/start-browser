#!/bin/bash
# Start Wayland compositor and browser in kiosk mode

# Wait for DRM device
for i in {1..10}; do
    [ -e /dev/dri/card0 ] && break
    sleep 1
done

# Set environment
export XDG_RUNTIME_DIR=/run/user/$(id -u)
mkdir -p "$XDG_RUNTIME_DIR"
chmod 0700 "$XDG_RUNTIME_DIR"

# Start weston in background
weston --backend=drm-backend.so --tty=1 &
WESTON_PID=$!

# Wait for weston to start
sleep 3

# Launch cog browser in kiosk mode
COG_PLATFORM_FDO_VIEW_FULLSCREEN=1 \
COG_PLATFORM_FDO_VIEW_MAXIMIZE=1 \
cog --platform=fdo "${COG_HOME_URI:-https://wpewebkit.org}"

# If cog exits, kill weston
kill $WESTON_PID
